<div class="create-event-page" *ngIf="!loading; else loadingState">
    <section class="create-event-hero card shadow-sm">
        <div class="create-event-hero__content">
            <h1>Create a Volunteer Event</h1>
            <p>Design experiences that bring volunteers and communities together. Provide clear details so your event fills up quickly.</p>
            <ul class="create-event-hero__list" *ngIf="isOrganizer">
                <li><i class="bi bi-buildings"></i>Events will be published under <strong>{{ organizations.length > 0 ? organizations[0].name : '' }}</strong></li>
                <li><i class="bi bi-people"></i>Volunteers can sign up instantly once published</li>
                <li><i class="bi bi-shield-check"></i>Need support? Organizer dashboard has moderation tools</li>
            </ul>
            <ul class="create-event-hero__list" *ngIf="isAdmin">
                <li><i class="bi bi-buildings"></i>Select any approved organization to host this event</li>
                <li><i class="bi bi-bar-chart"></i>Help organizers keep their calendars full</li>
                <li><i class="bi bi-person-workspace"></i>Review event status in the admin dashboard</li>
            </ul>
        </div>
        <div class="create-event-hero__image">
            <img src="assets/VS_Logo_Banner.png" alt="VolunteerSync banner">
        </div>
    </section>

    <section class="create-event-form card shadow-sm">
        <h2>Event Details</h2>
        <p class="create-event-form__subtitle">Fill out the information below. Fields marked with * are required.</p>

        <div *ngIf="successMessage" class="create-event-alert create-event-alert--success">
            <i class="bi bi-check-circle-fill me-2"></i>{{ successMessage }}
        </div>
        <div *ngIf="errorMessage" class="create-event-alert create-event-alert--error">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ errorMessage }}
        </div>

        <form (ngSubmit)="onSubmit()" novalidate>
            <div class="create-event-section">
                <h3>Event Information</h3>
                <div class="create-event-grid">
                    <div class="create-event-field create-event-field--full">
                        <label for="title">Event Title *</label>
                        <input type="text" id="title" name="title" [(ngModel)]="event.title" maxlength="100" required [disabled]="!canCreateEvents">
                    </div>
                    <div class="create-event-field create-event-field--full">
                        <label for="description">Description *</label>
                        <textarea id="description" name="description" rows="4" [(ngModel)]="event.description" maxlength="65535" required [disabled]="!canCreateEvents"></textarea>
                    </div>
                    <div class="create-event-field">
                        <label for="eventDate">Event Date *</label>
                        <input type="date" id="eventDate" name="eventDate" [(ngModel)]="event.eventDate" [attr.min]="today" required [disabled]="!canCreateEvents">
                    </div>
                    <div class="create-event-field">
                        <label for="eventTime">Event Time *</label>
                        <div class="create-event-time-picker">
                            <select id="eventHour" name="eventHour" [(ngModel)]="eventHour" (ngModelChange)="updateEventTime()" required [disabled]="!canCreateEvents" class="create-event-time-select">
                                <option *ngFor="let hour of availableHours" [ngValue]="hour">{{ hour }}</option>
                            </select>
                            <span class="create-event-time-separator">:</span>
                            <select id="eventMinute" name="eventMinute" [(ngModel)]="eventMinute" (ngModelChange)="updateEventTime()" required [disabled]="!canCreateEvents" class="create-event-time-select">
                                <option *ngFor="let minute of availableMinutes" [ngValue]="minute">{{ minute.toString().padStart(2, '0') }}</option>
                            </select>
                            <select id="eventAmPm" name="eventAmPm" [(ngModel)]="eventAmPm" (ngModelChange)="updateEventTime()" required [disabled]="!canCreateEvents" class="create-event-time-select create-event-time-ampm">
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>
                        <input type="hidden" name="eventTime" [(ngModel)]="event.eventTime" required>
                    </div>
                    <div class="create-event-field">
                        <label for="eventLengthHours">Event Length (Hours) *</label>
                        <input type="number" id="eventLengthHours" name="eventLengthHours" min="1" max="24" [(ngModel)]="event.eventLengthHours" required [disabled]="!canCreateEvents">
                    </div>
                    <div class="create-event-field">
                        <label for="numNeeded">Volunteers Needed *</label>
                        <input type="number" id="numNeeded" name="numNeeded" min="1" max="10000" [(ngModel)]="event.numNeeded" required [disabled]="!canCreateEvents">
                    </div>
                </div>
            </div>

            <div class="create-event-section">
                <h3>Tags &amp; Attributes</h3>
                <p class="create-event-form__subtitle">
                    Highlight key details like "Kid-friendly", "Light labor", or "Outdoors" so volunteers can quickly
                    find events that fit their interests and abilities.
                </p>

                <div *ngIf="tagsError" class="create-event-alert create-event-alert--error mb-2">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ tagsError }}
                </div>

                <div class="create-event-tags-wrapper" *ngIf="availableTags.length > 0; else noTagsAvailable">
                    <!-- Selected Tags Display -->
                    <div class="create-event-tags-selected" *ngIf="selectedTags.length > 0">
                        <label class="create-event-tags-label">Selected Tags:</label>
                        <div class="create-event-tags-badges">
                            <span class="create-event-tag-badge" *ngFor="let tag of selectedTags">
                                {{ tag.name }}
                                <button type="button" class="create-event-tag-remove" 
                                    (click)="removeTag(tag.tagId)" 
                                    [disabled]="!canCreateEvents"
                                    [attr.aria-label]="'Remove ' + tag.name">
                                    <i class="bi bi-x"></i>
                                </button>
                            </span>
                        </div>
                    </div>

                    <!-- Multi-Select Dropdown -->
                    <div class="create-event-tags-dropdown-wrapper">
                        <button type="button" 
                            class="create-event-tags-dropdown-toggle"
                            (click)="tagsDropdownOpen = !tagsDropdownOpen"
                            [disabled]="!canCreateEvents || tagsLoading"
                            [class.loading]="tagsLoading">
                            <i class="bi bi-tags"></i>
                            <span>{{ selectedTags.length > 0 ? selectedTags.length + ' tag' + (selectedTags.length !== 1 ? 's' : '') + ' selected' : 'Select tags...' }}</span>
                            <i class="bi" [ngClass]="tagsDropdownOpen ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                        </button>

                        <div class="create-event-tags-dropdown" *ngIf="tagsDropdownOpen" (click)="$event.stopPropagation()">
                            <div class="create-event-tags-search">
                                <i class="bi bi-search"></i>
                                <input type="text" 
                                    placeholder="Search tags..." 
                                    [(ngModel)]="tagSearchQuery"
                                    name="tagSearchQuery"
                                    (click)="$event.stopPropagation()">
                            </div>
                            <div class="create-event-tags-list">
                                <div *ngIf="filteredTags.length === 0" class="create-event-tags-empty">
                                    No tags found matching "{{ tagSearchQuery }}"
                                </div>
                                <label class="create-event-tags-option" 
                                    *ngFor="let tag of filteredTags"
                                    (click)="toggleTag(tag.tagId)">
                                    <input type="checkbox" 
                                        [checked]="selectedTagIds.includes(tag.tagId)"
                                        (change)="$event.stopPropagation()"
                                        readonly>
                                    <span>{{ tag.name }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template #noTagsAvailable>
                    <p class="text-muted mb-0">No tags are currently configured. You can still create this event; tags
                        can be added later once they are available.</p>
                </ng-template>
            </div>

            <div class="create-event-section">
                <h3>Location</h3>
                <div class="create-event-grid">
                    <div class="create-event-field">
                        <label for="locationName">Location Name *</label>
                        <input type="text" id="locationName" name="locationName" [(ngModel)]="event.locationName" maxlength="100" required [disabled]="!canCreateEvents">
                    </div>
                    <div class="create-event-field create-event-field--full">
                        <label for="address">Street Address *</label>
                        <input type="text" id="address" name="address" [(ngModel)]="event.address" maxlength="65535" required [disabled]="!canCreateEvents">
                    </div>
                    <div class="create-event-field">
                        <label for="city">City *</label>
                        <input type="text" id="city" name="city" [(ngModel)]="event.city" maxlength="100" required [disabled]="!canCreateEvents">
                    </div>
                    <div class="create-event-field">
                        <label for="state">State *</label>
                        <select id="state" name="state" [(ngModel)]="event.state" required [disabled]="!canCreateEvents">
                            <option value="">Select a state</option>
                            <option *ngFor="let state of usStates" [value]="state.code">{{ state.name }} ({{ state.code }})</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="create-event-section">
                <h3>Organization</h3>
                <ng-container *ngIf="isOrganizer; else adminOrgSelect">
                    <div class="create-event-field create-event-field--full">
                        <label>Hosting Organization</label>
                        <div class="create-event-field__readonly">
                            {{ organizations.length > 0 ? organizations[0].name : '' }}
                        </div>
                        <input type="hidden" name="organizationId" [(ngModel)]="event.organizationId">
                        <small class="form-text">Organizers can only create events for their linked organization.</small>
                    </div>
                </ng-container>
                <ng-template #adminOrgSelect>
                    <div class="create-event-field create-event-field--full">
                        <label for="organizationId">Select Organization *</label>
                        <select id="organizationId" name="organizationId" [(ngModel)]="event.organizationId" required [disabled]="!canCreateEvents">
                            <option *ngFor="let org of organizations" [value]="org.organizationId">{{ org.name }}</option>
                        </select>
                    </div>
                </ng-template>
            </div>

            <div class="create-event-actions">
                <button type="submit" class="btn btn-success btn-lg" [disabled]="loading || !canCreateEvents">Create Event</button>
                <a routerLink="/events" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </section>
</div>

<ng-template #loadingState>
    <div class="create-event-loading">
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Preparing event formâ€¦</p>
    </div>
</ng-template>