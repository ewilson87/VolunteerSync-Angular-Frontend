<div class="container mt-4">
    <!-- Loading state -->
    <div *ngIf="isLoading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading event management data...</p>
    </div>

    <!-- Error message -->
    <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" (click)="error = ''"></button>
    </div>

    <!-- Success message -->
    <div *ngIf="success" class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" (click)="success = ''"></button>
    </div>

    <!-- Access restriction -->
    <div *ngIf="!isLoading && (!currentUser || (currentUser.role !== 'organizer' && currentUser.role !== 'admin'))"
        class="alert alert-warning">
        <h4 class="alert-heading">Organizer Access Only</h4>
        <p>This page is restricted to organization administrators and event organizers.</p>
        <hr>
        <p class="mb-0">Please log in with an organizer account to access these features.</p>
    </div>

    <!-- No organization warning -->
    <div *ngIf="!isLoading && currentUser && (currentUser.role === 'organizer' || currentUser.role === 'admin') && !currentUser.organizationId"
        class="alert alert-warning">
        <h4 class="alert-heading">No Organization</h4>
        <p>You are not currently associated with any organization.</p>
        <hr>
        <p class="mb-0">Please contact an administrator to be added to an organization before managing events.</p>
    </div>

    <!-- Event Management Dashboard -->
    <div
        *ngIf="!isLoading && currentUser && (currentUser.role === 'organizer' || currentUser.role === 'admin') && currentUser.organizationId && !showRegistrations">
        <h1 class="mb-4">Event Management</h1>

        <!-- Organization Info -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Organization Information</h5>
            </div>
            <div class="card-body" *ngIf="userOrganization">
                <h3>{{ userOrganization.name }}</h3>
                <p class="lead">{{ userOrganization.description }}</p>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Contact Email:</strong> {{ userOrganization.contactEmail }}</p>
                        <p><strong>Contact Phone:</strong> {{ userOrganization.contactPhone }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Website:</strong> <a [href]="userOrganization.website" target="_blank">{{
                                userOrganization.website }}</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create/Edit Event Form -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ isEditMode ? 'Edit Event' : 'Create New Event' }}</h5>
                <button *ngIf="!isEditMode" class="btn btn-light btn-sm" (click)="onCreateEvent()">
                    <i class="bi bi-plus-circle"></i> New Event
                </button>
            </div>
            <div class="card-body">
                <form [formGroup]="eventForm" (ngSubmit)="onSubmitEvent()">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Event Title*</label>
                            <input type="text" class="form-control" id="title" formControlName="title"
                                [ngClass]="{'is-invalid': eventForm.get('title')?.invalid && eventForm.get('title')?.touched}">
                            <div class="invalid-feedback" *ngIf="eventForm.get('title')?.errors?.['required']">
                                Title is required.
                            </div>
                            <div class="invalid-feedback" *ngIf="eventForm.get('title')?.errors?.['maxlength']">
                                Title cannot exceed 100 characters.
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="eventDate" class="form-label">Event Date*</label>
                            <input type="date" class="form-control" id="eventDate" formControlName="eventDate"
                                [ngClass]="{'is-invalid': eventForm.get('eventDate')?.invalid && eventForm.get('eventDate')?.touched}">
                            <div class="invalid-feedback">
                                Event date is required.
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="eventTime" class="form-label">Event Time*</label>
                            <input type="time" class="form-control" id="eventTime" formControlName="eventTime"
                                [ngClass]="{'is-invalid': eventForm.get('eventTime')?.invalid && eventForm.get('eventTime')?.touched}">
                            <div class="invalid-feedback">
                                Event time is required.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description*</label>
                        <textarea class="form-control" id="description" rows="3" formControlName="description"
                            [ngClass]="{'is-invalid': eventForm.get('description')?.invalid && eventForm.get('description')?.touched}"></textarea>
                        <div class="invalid-feedback" *ngIf="eventForm.get('description')?.errors?.['required']">
                            Description is required.
                        </div>
                        <div class="invalid-feedback" *ngIf="eventForm.get('description')?.errors?.['maxlength']">
                            Description cannot exceed 500 characters.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="locationName" class="form-label">Location Name*</label>
                        <input type="text" class="form-control" id="locationName" formControlName="locationName"
                            [ngClass]="{'is-invalid': eventForm.get('locationName')?.invalid && eventForm.get('locationName')?.touched}">
                        <div class="invalid-feedback">
                            Location name is required.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="address" class="form-label">Address*</label>
                        <input type="text" class="form-control" id="address" formControlName="address"
                            [ngClass]="{'is-invalid': eventForm.get('address')?.invalid && eventForm.get('address')?.touched}">
                        <div class="invalid-feedback">
                            Address is required.
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="city" class="form-label">City*</label>
                            <input type="text" class="form-control" id="city" formControlName="city"
                                [ngClass]="{'is-invalid': eventForm.get('city')?.invalid && eventForm.get('city')?.touched}">
                            <div class="invalid-feedback">
                                City is required.
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="state" class="form-label">State*</label>
                            <select class="form-select" id="state" formControlName="state"
                                [ngClass]="{'is-invalid': eventForm.get('state')?.invalid && eventForm.get('state')?.touched}">
                                <option value="">Select State</option>
                                <option *ngFor="let state of states" [value]="state">{{ state }}</option>
                            </select>
                            <div class="invalid-feedback">
                                State is required.
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="numNeeded" class="form-label">Volunteers Needed*</label>
                            <input type="number" class="form-control" id="numNeeded" formControlName="numNeeded" min="1"
                                [ngClass]="{'is-invalid': eventForm.get('numNeeded')?.invalid && eventForm.get('numNeeded')?.touched}">
                            <div class="invalid-feedback" *ngIf="eventForm.get('numNeeded')?.errors?.['required']">
                                Number of volunteers is required.
                            </div>
                            <div class="invalid-feedback" *ngIf="eventForm.get('numNeeded')?.errors?.['min']">
                                At least 1 volunteer is required.
                            </div>
                            <div class="invalid-feedback" *ngIf="eventForm.get('numNeeded')?.errors?.['max']">
                                Maximum 1000 volunteers allowed.
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-secondary" (click)="cancelForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">{{ isEditMode ? 'Update Event' : 'Create Event'
                            }}</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Events List -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Your Organization's Events</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Location</th>
                                <th>Registrations</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let event of events" [class.table-secondary]="isEventInPast(event)">
                                <td>{{ event.title }}</td>
                                <td>{{ event.eventDate }} {{ event.eventTime }}</td>
                                <td>{{ event.city }}, {{ event.state }}</td>
                                <td>
                                    <span *ngIf="event.numSignedUp !== undefined">{{ event.numSignedUp }} / {{
                                        event.numNeeded }}</span>
                                    <span *ngIf="event.numSignedUp === undefined">0 / {{ event.numNeeded }}</span>
                                </td>
                                <td>
                                    <span class="badge"
                                        [ngClass]="isEventInPast(event) ? 'bg-secondary' : 'bg-success'">
                                        {{ isEventInPast(event) ? 'Past' : 'Upcoming' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-info me-1"
                                            (click)="viewRegistrations(event.eventId!)">
                                            <i class="bi bi-people"></i> Registrations
                                        </button>
                                        <button class="btn btn-sm btn-warning me-1" (click)="onEditEvent(event)"
                                            [disabled]="isEventInPast(event)">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" (click)="confirmDeleteEvent(event)"
                                            [disabled]="isEventInPast(event)">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr *ngIf="events.length === 0">
                                <td colspan="6" class="text-center">No events found for your organization.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div *ngIf="showDeleteConfirmation" class="modal d-block" tabindex="-1"
            style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete Event</h5>
                        <button type="button" class="btn-close" (click)="cancelDelete()"></button>
                    </div>
                    <div class="modal-body" *ngIf="selectedEvent">
                        <p>Are you sure you want to delete the event <strong>{{ selectedEvent.title }}</strong>?</p>
                        <p class="text-danger">This action cannot be undone. All registrations for this event will be
                            permanently removed.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
                        <button type="button" class="btn btn-danger" (click)="deleteEvent()">Delete Event</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Registrations View -->
    <div *ngIf="!isLoading && showRegistrations && selectedEventId" class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Event Registrations</h1>
            <button class="btn btn-secondary" (click)="hideRegistrations()">
                <i class="bi bi-arrow-left"></i> Back to Events
            </button>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">{{ getSelectedEvent()?.title }}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Date:</strong> {{ getSelectedEvent()?.eventDate }}</p>
                        <p><strong>Time:</strong> {{ getSelectedEvent()?.eventTime }}</p>
                        <p><strong>Location:</strong> {{ getSelectedEvent()?.locationName }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Address:</strong> {{ getSelectedEvent()?.address }}</p>
                        <p><strong>City/State:</strong> {{ getSelectedEvent()?.city }}, {{ getSelectedEvent()?.state }}
                        </p>
                        <p>
                            <strong>Registrations:</strong>
                            <span *ngIf="eventSignups.length > 0">{{ eventSignups.length }} / {{
                                getSelectedEvent()?.numNeeded }}</span>
                            <span *ngIf="eventSignups.length === 0">0 / {{ getSelectedEvent()?.numNeeded }}</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Registered Volunteers</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let signup of eventSignups">
                                <td>{{ getUserName(signup.userId!) }}</td>
                                <td>{{ getUserEmail(signup.userId!) }}</td>
                                <td>{{ signup.signupDate | date:'medium' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" (click)="cancelRegistration(signup.signupId!)"
                                        [disabled]="isEventInPast(getSelectedEvent()!)">
                                        <i class="bi bi-x-circle"></i> Cancel Registration
                                    </button>
                                </td>
                            </tr>
                            <tr *ngIf="eventSignups.length === 0">
                                <td colspan="4" class="text-center">No volunteers have registered for this event yet.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>